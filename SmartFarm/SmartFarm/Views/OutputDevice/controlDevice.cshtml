@using System.Collections.Generic;
@using SmartFarm.Models;
@model List<OutputModel>;
@{
  ViewData["Title"] = "Remote Control";
}
@section CustomCss{
<link rel="stylesheet" type="text/css" href="/css/dinhCss.css" />
}
<!-- -----------------SECTION CONTENT------------------ -->
<section class="section-content">
  <h1 class="heading-1 mb-5 d-flex align-items-center">
    <img src="/image/cogs-solid.svg" class="heading__icon me-4" />
    Điều khiển từ xa
  </h1>

  <div class="row">
    <div class="col-12 col-lg-4 mb-5 mb-lg-0">
      <figure class="map">
        <figcaption class="map__unit">(&#13217;)</figcaption>
        <img src="/image/map.png" class="img-fluid" alt="map image" />
      </figure>
    </div>

    <div class="col-lg-8 col-12">
      <div class="devices">
        <div class="device-output mb-5">
          <h2 class="heading-2 device-type mb-5">Output</h2>
          <div class="device-container"style="margin-top: 3rem;">
            @foreach (var sp in Model)
            {
              <figure class="device__figure">
                <img src="@sp.img" alt="device image" class="device__img" />
                <div class="device__details">
                  <div class="device__name">@sp.name</div>
                  <div class="device__coordinates">
                    @sp.viTri
                  </div>
                </div>
                <label class="switch3">
                  <input type="checkbox" feedName="@sp.feedName" />
                  <div></div>
                </label>
              </figure>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
@section Scripts{
<script type="text/javascript">
  var user_Adafruit={
      aIO_key:"aio_JCEU76mVFHHLoYLJHuAaDRR3WRgy",
      userName:"luucongdinh"
  }

  function requestPost(key_feed,aIO_key,userName,data){
    var _data={value: `${data}`};
    var url=`https://io.adafruit.com/api/v2/${userName}/feeds/${key_feed}/data`;
    console.log(url);
    fetch(url, {
      method: "POST",
      body: JSON.stringify(_data),
      headers: {
        "Content-Type": "application/json",
        "X-Aio-Key": `${aIO_key}`
      } 
    })
        .then(response => response.json()) 
        .then(json => console.log(json))
        .catch(err => console.log(err));
  }
  function initial(){
    document.querySelectorAll(".switch3 input").forEach((el) => {
      var dad = el.parentElement;
      var key_feed=el.getAttribute("feedName");
      var url=`https://io.adafruit.com/api/v2/${user_Adafruit.userName}/feeds/${key_feed}/data?limit=1`;
      console.log(url);
      fetch(url, {
        method: "GET",
        headers: {
          "X-Aio-Key": `${user_Adafruit.aIO_key}`
        } 
        })
          .then(response=>response.json())
          .then(data=>{
            console.log(data);
            if(data[0].value!=="0"){
                if (el.checked == false) {
                  el.checked = true;
                  if(dad.classList.length==1) dad.classList.add("switch3-checked");
                }
              }
            else 
            { 
              el.checked = false;
              dad.classList.remove("switch3-checked");
            }
          })
          .catch(err => console.log(err));
    });}
  initial();
  setInterval(initial,2500);
  document.querySelectorAll(".switch3 input").forEach((el) => {
    var dad = el.parentElement;
    var key_feed=el.getAttribute("feedName");
    el.addEventListener("change", function (e) {
      if (this.checked )
      {
        if( dad.classList.length==1) dad.classList.add("switch3-checked");
        requestPost(key_feed,user_Adafruit.aIO_key,user_Adafruit.userName,1);
      }
      else
      {
        dad.classList.remove("switch3-checked");
        requestPost(key_feed,user_Adafruit.aIO_key,user_Adafruit.userName,0);
      }
    });
  });
</script>
}
